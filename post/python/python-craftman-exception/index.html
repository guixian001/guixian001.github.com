<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Python 工匠读书笔记 5：异常和错误处理 - Guixian 的日常记录</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Chen Guixian"><meta name=description content='[toc]
基础知识 优先使用异常捕获 一个简单函数 写一个简单的函数，它接收一个整数参数，返回对它加1后的结果。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ if isinstance(value, int): return value + 1 elif isinstance(value, str) and value.isdigit(): return int(value) + 1 else: print(f&#39;Unable to perform incr for value: "{value}"&#39;) def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ try: return int(value) + 1 except (TypeError, ValueError) as e: print(f&#39;Unable to perform incr for value: "{value}", error: {e}&#39;) 两种编程风格 LBLY（look befor you leap） 三思而后行 EAFP（easier to ask for forgiveness than permission） 获取原谅比许可简单 小结 Python 社区偏于使用基于异常捕获的 EAFP 风格 代码更为精简，不需要开发者用分支完全覆盖各种可能出错的情况，只需要捕获可能发生的异常即可 EAFP 的代码通常性能更好 如果是 &lsquo;73&rsquo; LBLY 每次调用都需要进行额外的 isinstance 和 isdigit 的判断。EAFP 每次调用直接进行转换，返回结果 Python 的抛出和捕获异常比较轻量 try 语句常用知识 1 2 3 4 5 6 7 8 9 10 11 12 13 def safe_int(value): """尝试把输入转换为整数""" try: return int(value) except TypeError: # 当某类异常被抛出时，将会执行对应 except 下的语句 print(f&#39;type error: {type(value)} is invalid&#39;) except ValueError: # 你可以在一个 try 语句块下写多个 except print(f&#39;value error: {value} is invalid&#39;) finally: # finally 里的语句，无论如何都会被执行，哪怕已经执行了return print(&#39;function completed&#39;) 把更精确的 except 放在前面 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def incr_by_key(d, key): try: d[key] += 1 except Exception as e: ➊ print(f&#39;Unknown error: {e}&#39;) except KeyError: print(f&#39;key {key} does not exists&#39;) def incr_by_key(d, key): try: d[key] += 1 except KeyError: print(f&#39;key {key} does not exists&#39;) except Exception as e: print(f&#39;Unknown error: {e}&#39;) 使用 else 分支 在使用 try 捕获异常的时候，有时需要再仅一切正常的时候做某件事
'><meta name=keywords content="程序员的日常记录,编码人生,生活笔记"><meta name=generator content="Hugo 0.134.3 with theme even"><link rel=canonical href=https://blog.chenguixian.com/post/python/python-craftman-exception/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:url" content="https://blog.chenguixian.com/post/python/python-craftman-exception/"><meta property="og:site_name" content="Guixian 的日常记录"><meta property="og:title" content="Python 工匠读书笔记 5：异常和错误处理"><meta property="og:description" content='[toc]
基础知识 优先使用异常捕获 一个简单函数 写一个简单的函数，它接收一个整数参数，返回对它加1后的结果。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ if isinstance(value, int): return value + 1 elif isinstance(value, str) and value.isdigit(): return int(value) + 1 else: print(f&#39;Unable to perform incr for value: "{value}"&#39;) def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ try: return int(value) + 1 except (TypeError, ValueError) as e: print(f&#39;Unable to perform incr for value: "{value}", error: {e}&#39;) 两种编程风格 LBLY（look befor you leap） 三思而后行 EAFP（easier to ask for forgiveness than permission） 获取原谅比许可简单 小结 Python 社区偏于使用基于异常捕获的 EAFP 风格 代码更为精简，不需要开发者用分支完全覆盖各种可能出错的情况，只需要捕获可能发生的异常即可 EAFP 的代码通常性能更好 如果是 ‘73’ LBLY 每次调用都需要进行额外的 isinstance 和 isdigit 的判断。EAFP 每次调用直接进行转换，返回结果 Python 的抛出和捕获异常比较轻量 try 语句常用知识 1 2 3 4 5 6 7 8 9 10 11 12 13 def safe_int(value): """尝试把输入转换为整数""" try: return int(value) except TypeError: # 当某类异常被抛出时，将会执行对应 except 下的语句 print(f&#39;type error: {type(value)} is invalid&#39;) except ValueError: # 你可以在一个 try 语句块下写多个 except print(f&#39;value error: {value} is invalid&#39;) finally: # finally 里的语句，无论如何都会被执行，哪怕已经执行了return print(&#39;function completed&#39;) 把更精确的 except 放在前面 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def incr_by_key(d, key): try: d[key] += 1 except Exception as e: ➊ print(f&#39;Unknown error: {e}&#39;) except KeyError: print(f&#39;key {key} does not exists&#39;) def incr_by_key(d, key): try: d[key] += 1 except KeyError: print(f&#39;key {key} does not exists&#39;) except Exception as e: print(f&#39;Unknown error: {e}&#39;) 使用 else 分支 在使用 try 捕获异常的时候，有时需要再仅一切正常的时候做某件事'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-11-18T18:08:22+08:00"><meta property="article:modified_time" content="2022-11-18T18:08:22+08:00"><meta property="article:tag" content="Python"><meta itemprop=name content="Python 工匠读书笔记 5：异常和错误处理"><meta itemprop=description content='[toc]
基础知识 优先使用异常捕获 一个简单函数 写一个简单的函数，它接收一个整数参数，返回对它加1后的结果。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ if isinstance(value, int): return value + 1 elif isinstance(value, str) and value.isdigit(): return int(value) + 1 else: print(f&#39;Unable to perform incr for value: "{value}"&#39;) def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ try: return int(value) + 1 except (TypeError, ValueError) as e: print(f&#39;Unable to perform incr for value: "{value}", error: {e}&#39;) 两种编程风格 LBLY（look befor you leap） 三思而后行 EAFP（easier to ask for forgiveness than permission） 获取原谅比许可简单 小结 Python 社区偏于使用基于异常捕获的 EAFP 风格 代码更为精简，不需要开发者用分支完全覆盖各种可能出错的情况，只需要捕获可能发生的异常即可 EAFP 的代码通常性能更好 如果是 ‘73’ LBLY 每次调用都需要进行额外的 isinstance 和 isdigit 的判断。EAFP 每次调用直接进行转换，返回结果 Python 的抛出和捕获异常比较轻量 try 语句常用知识 1 2 3 4 5 6 7 8 9 10 11 12 13 def safe_int(value): """尝试把输入转换为整数""" try: return int(value) except TypeError: # 当某类异常被抛出时，将会执行对应 except 下的语句 print(f&#39;type error: {type(value)} is invalid&#39;) except ValueError: # 你可以在一个 try 语句块下写多个 except print(f&#39;value error: {value} is invalid&#39;) finally: # finally 里的语句，无论如何都会被执行，哪怕已经执行了return print(&#39;function completed&#39;) 把更精确的 except 放在前面 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def incr_by_key(d, key): try: d[key] += 1 except Exception as e: ➊ print(f&#39;Unknown error: {e}&#39;) except KeyError: print(f&#39;key {key} does not exists&#39;) def incr_by_key(d, key): try: d[key] += 1 except KeyError: print(f&#39;key {key} does not exists&#39;) except Exception as e: print(f&#39;Unknown error: {e}&#39;) 使用 else 分支 在使用 try 捕获异常的时候，有时需要再仅一切正常的时候做某件事'><meta itemprop=datePublished content="2022-11-18T18:08:22+08:00"><meta itemprop=dateModified content="2022-11-18T18:08:22+08:00"><meta itemprop=wordCount content="5800"><meta itemprop=keywords content="Python"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 工匠读书笔记 5：异常和错误处理"><meta name=twitter:description content='[toc]
基础知识 优先使用异常捕获 一个简单函数 写一个简单的函数，它接收一个整数参数，返回对它加1后的结果。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ if isinstance(value, int): return value + 1 elif isinstance(value, str) and value.isdigit(): return int(value) + 1 else: print(f&#39;Unable to perform incr for value: "{value}"&#39;) def incr_by_one(value): """对输入整数加1，返回新的值 :param value: 整型，或者可以转成整型的字符串 :return: 整型结果 """ try: return int(value) + 1 except (TypeError, ValueError) as e: print(f&#39;Unable to perform incr for value: "{value}", error: {e}&#39;) 两种编程风格 LBLY（look befor you leap） 三思而后行 EAFP（easier to ask for forgiveness than permission） 获取原谅比许可简单 小结 Python 社区偏于使用基于异常捕获的 EAFP 风格 代码更为精简，不需要开发者用分支完全覆盖各种可能出错的情况，只需要捕获可能发生的异常即可 EAFP 的代码通常性能更好 如果是 ‘73’ LBLY 每次调用都需要进行额外的 isinstance 和 isdigit 的判断。EAFP 每次调用直接进行转换，返回结果 Python 的抛出和捕获异常比较轻量 try 语句常用知识 1 2 3 4 5 6 7 8 9 10 11 12 13 def safe_int(value): """尝试把输入转换为整数""" try: return int(value) except TypeError: # 当某类异常被抛出时，将会执行对应 except 下的语句 print(f&#39;type error: {type(value)} is invalid&#39;) except ValueError: # 你可以在一个 try 语句块下写多个 except print(f&#39;value error: {value} is invalid&#39;) finally: # finally 里的语句，无论如何都会被执行，哪怕已经执行了return print(&#39;function completed&#39;) 把更精确的 except 放在前面 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def incr_by_key(d, key): try: d[key] += 1 except Exception as e: ➊ print(f&#39;Unknown error: {e}&#39;) except KeyError: print(f&#39;key {key} does not exists&#39;) def incr_by_key(d, key): try: d[key] += 1 except KeyError: print(f&#39;key {key} does not exists&#39;) except Exception as e: print(f&#39;Unknown error: {e}&#39;) 使用 else 分支 在使用 try 捕获异常的时候，有时需要再仅一切正常的时候做某件事'><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Guixian 的日常记录</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Guixian 的日常记录</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Python 工匠读书笔记 5：异常和错误处理</h1><div class=post-meta><span class=post-time>2022-11-18</span><div class=post-category><a href=/categories/python%E5%B7%A5%E5%8C%A0/>Python工匠</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#基础知识>基础知识</a><ul><li><a href=#优先使用异常捕获>优先使用异常捕获</a></li><li><a href=#try-语句常用知识>try 语句常用知识</a></li><li><a href=#抛出异常而不是返回错误>抛出异常，而不是返回错误</a></li><li><a href=#使用上下文管理器>使用上下文管理器</a></li></ul></li><li><a href=#案例故事>案例故事</a><ul><li><a href=#提前奔溃也挺好>提前奔溃也挺好</a></li><li><a href=#异常与抽象的一致性>异常与抽象的一致性</a></li></ul></li><li><a href=#编程建议>编程建议</a><ul><li><a href=#不要随意忽略异常>不要随意忽略异常</a></li><li><a href=#不要手动做数据校验>不要手动做数据校验</a></li><li><a href=#抛出可区分的异常>抛出可区分的异常</a></li><li><a href=#不要使用-assert-来检查参数合法性>不要使用 assert 来检查参数合法性</a></li><li><a href=#无需处理是最好的错误处理>无需处理是最好的错误处理</a></li></ul></li><li><a href=#总结>总结</a><ul><li><a href=#基础知识-1>基础知识</a></li><li><a href=#错误处理和参数校验>错误处理和参数校验</a></li><li><a href=#当你捕获异常时>当你捕获异常时</a></li><li><a href=#当你抛出异常时>当你抛出异常时</a></li></ul></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=post-content><p>[toc]</p><h2 id=基础知识>基础知识</h2><h3 id=优先使用异常捕获>优先使用异常捕获</h3><h4 id=一个简单函数>一个简单函数</h4><p>写一个简单的函数，它接收一个整数参数，返回对它加1后的结果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>incr_by_one</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;对输入整数加1，返回新的值
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param value: 整型，或者可以转成整型的字符串
</span></span></span><span class=line><span class=cl><span class=s2>    :return: 整型结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=ow>and</span> <span class=n>value</span><span class=o>.</span><span class=n>isdigit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unable to perform incr for value: &#34;</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#34;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incr_by_one</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;对输入整数加1，返回新的值
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param value: 整型，或者可以转成整型的字符串
</span></span></span><span class=line><span class=cl><span class=s2>    :return: 整型结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=p>(</span><span class=ne>TypeError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unable to perform incr for value: &#34;</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1>&#34;, error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=两种编程风格>两种编程风格</h4><ul><li>LBLY（look befor you leap） 三思而后行</li><li>EAFP（easier to ask for forgiveness than permission） 获取原谅比许可简单</li></ul><h4 id=小结>小结</h4><ol><li>Python 社区偏于使用基于异常捕获的 EAFP 风格</li><li>代码更为精简，不需要开发者用分支完全覆盖各种可能出错的情况，只需要捕获可能发生的异常即可</li><li>EAFP 的代码通常性能更好 如果是 &lsquo;73&rsquo; LBLY 每次调用都需要进行额外的 isinstance 和 isdigit 的判断。EAFP 每次调用直接进行转换，返回结果</li><li>Python 的抛出和捕获异常比较轻量</li></ol><h3 id=try-语句常用知识>try 语句常用知识</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_int</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;尝试把输入转换为整数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>TypeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当某类异常被抛出时，将会执行对应 except 下的语句</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;type error: </span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>value</span><span class=p>)</span><span class=si>}</span><span class=s1> is invalid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 你可以在一个 try 语句块下写多个 except</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;value error: </span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s1> is invalid&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># finally 里的语句，无论如何都会被执行，哪怕已经执行了return</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;function completed&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=把更精确的-except-放在前面>把更精确的 except 放在前面</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>incr_by_key</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span> <span class=err>➊</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unknown error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;key </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s1> does not exists&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>incr_by_key</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;key </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s1> does not exists&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unknown error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=使用-else-分支>使用 else 分支</h4><p>在使用 try 捕获异常的时候，有时需要再仅一切正常的时候做某件事</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#同步用户资料到外部系统，仅当同步成功时发送通知消息</span>
</span></span><span class=line><span class=cl><span class=n>sync_succeeded</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sync_profile</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>profile</span><span class=p>,</span> <span class=n>to_external</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sync_succeeded</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Error while syncing user profile&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>sync_succeeded</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>send_notification</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=s1>&#39;profile sync succeeded&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sync_profile</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>profile</span><span class=p>,</span> <span class=n>to_external</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Error while syncing user profile&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>send_notification</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=s1>&#39;profile sync succeeded&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>异常捕获里面的 else 标识：当 try 的语句没有异常时，才执行 else 里面的内容。需要注意：如果程序里面的 try 在碰到 return、break 等跳转语句中断本次异常捕获，那么即使没有抛出异常，那么 else 分支里面的逻辑也不会被执行。</p><h4 id=使用-空-raise-语句>使用 空 raise 语句</h4><p>场景：在处理异常时，有时我们只是想记录下某个异常，然后把它重新抛出，交由上层处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>incr_by_key</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;key </span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s1> does not exists, re-raise the exception&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=抛出异常而不是返回错误>抛出异常，而不是返回错误</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;接收名称，创建 Item 对象
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :return: (对象, 错误信息)，成功时错误信息为 &#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>MAX_LENGTH_OF_NAME</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=s1>&#39;name of item is too long&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>get_current_items</span><span class=p>())</span> <span class=o>&gt;</span> <span class=n>MAX_ITEMS_QUOTA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=s1>&#39;items is full&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Item</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>),</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_from_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>item</span><span class=p>,</span> <span class=n>err_msg</span> <span class=o>=</span> <span class=n>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>err_msg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>err_msg</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;item&lt;</span><span class=si>{name}</span><span class=s1>&gt; created&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateItemError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建 Item 失败&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建一个新的Item
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :raises: 当无法创建时抛出 CreateItemError
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>MAX_LENGTH_OF_NAME</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateItemError</span><span class=p>(</span><span class=s1>&#39;name of item is too long&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>get_current_items</span><span class=p>())</span> <span class=o>&gt;</span> <span class=n>MAX_ITEMS_QUOTA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateItemError</span><span class=p>(</span><span class=s1>&#39;items is full&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Item</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_from_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>CreateItemError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;item&lt;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&gt; created&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>优点：</p><ul><li>返回错误并非解决此类问题的最佳办法。这是因为这种做法会增加调用方处理错误的成本，尤其是当许多函数遵循这个规范，并且有很多层调用关系时。Python有完善的异常机制。</li><li><strong>新函数拥有更稳定的返回值类型</strong>，它永远只会返回Item类型或是抛出异常。</li><li><strong>异常在被捕获前会不断往调用栈上层汇报</strong>。因此create_item()的直接调用方也可以完全不处理CreateItemError，而交由更上层处理。异常的这个特点给了我们更多灵活性，但同时也带来了更大的风险。具体来说，假如程序缺少一个顶级的统一异常处理逻辑，那么某个被所有人忽视了的异常可能会层层上报，最终弄垮整个程序。</li></ul><h3 id=使用上下文管理器>使用上下文管理器</h3><p>with 与异常关系也比较密切。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>#使用with 打开文件，文件描述符会在作用域结束后自动被释放</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;foo.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>fp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=n>fp</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>要创建一个上下文管理器，只要实现__enter__和__exit__两个魔法方法即可。</p><h4 id=替代-finally-语句清理资源>替代 finally 语句清理资源</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>create_conn</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>send_text</span><span class=p>(</span><span class=s1>&#39;Hello, world!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unable to use connection: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>create_conn_obj</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建连接对象，并在退出上下文时自动关闭&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conn</span> <span class=o>=</span> <span class=n>create_conn</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>conn</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># __exit__会在管理器退出时调用</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl><span class=c1>#使用上下文管理器创建连接</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>create_conn_obj</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>send_text</span><span class=p>(</span><span class=s1>&#39;Hello, world!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Unable to use connection: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=用于忽略异常>用于忽略异常</h4><p>场景：有时程序会抛出一些不影响正常执行逻辑的异常。当你在关闭某个连接时，假如它已经是关闭状态了，解释器就会抛出AlreadyClosedError异常。这时，为了让程序正常运行下去，你必须用try语句来捕获并忽略这个异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>try:
</span></span><span class=line><span class=cl>    close_conn(conn)
</span></span><span class=line><span class=cl>except AlreadyClosedError:
</span></span><span class=line><span class=cl>    pass
</span></span></code></pre></td></tr></table></div></div><p>虽然这样的代码很简单，但没法复用。当项目中有很多地方要忽略这类异常时，这些try/except语句就会分布在各个角落，看上去非常凌乱。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ignore_closed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;忽略已经关闭的连接&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>exc_type</span> <span class=o>==</span> <span class=n>AlreadyClosedError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>ignore_closed</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>close_conn</span><span class=p>(</span><span class=n>conn</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=使用-contextmanager-装饰器>使用 contextmanager 装饰器</h4><p>目的：简化定义一个符合协议的管理器对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span></span><span class=line><span class=cl><span class=nd>@contextmanager</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_conn_obj</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建连接对象，并在退出上下文时自动关闭&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>create_conn</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>conn</span> 
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=案例故事>案例故事</h2><h3 id=提前奔溃也挺好>提前奔溃也挺好</h3><p>精确捕获，不是模糊的 Exception</p><h3 id=异常与抽象的一致性>异常与抽象的一致性</h3><h4 id=一个小-demo>一个小 Demo</h4><p>Web API，定义了一些常见的异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>raise error_codes.UNABLE_TO_UPVOTE
</span></span><span class=line><span class=cl>raise error_codes.USER_HAS_BEEN_BANNED
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p><code>{PROJECT}/util/image/processor.py</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def process_image(...):
</span></span><span class=line><span class=cl>    try:
</span></span><span class=line><span class=cl>        image = Image.open(fp)
</span></span><span class=line><span class=cl>    except Exception:
</span></span><span class=line><span class=cl>        raise error_codes.INVALID_IMAGE_UPLOADED
</span></span><span class=line><span class=cl>    ...
</span></span></code></pre></td></tr></table></div></div><p>process_image()函数会尝试打开一个文件对象。假如该文件不是有效的图片格式，就抛出error_codes.INVALID_IMAGE_UPLOADED异常。该异常会被Django中间件捕获，最终给用户返回“INVALID_IMAGE_UPLOADED”（上传的图片格式有误）错误码响应。</p><p>问题：</p><ol><li>最初编写 process_image 调用这个函数就只有"处理用户上传图片的 POST 请求"，为了偷懒，直接抛出了一个 API 的异常</li><li>但是当需要编写一个后台运行的图片批处理脚本时，刚好可以服用这个函数。就会存在问题<ol><li>必须引入 API 的异常类依赖来捕获异常</li><li>比如捕获 INVALID_IMAGE_UPLOADED 异常。哪怕图片就不是由用户上传的。</li></ol></li></ol><h4 id=避免抛出抽象级别高于当前模块的异常>避免抛出抽象级别高于当前模块的异常</h4><ul><li>APIErrorCode异常类的意义在于，表达一种能直接被终端用户（人）识别并消费的“错误代码”。它是整个项目中最高层的抽象之一。</li><li>出于方便，在一个底层图像处理模块里抛出了它。这打破了process_image()函数的抽象一致性，导致我无法在后台脚本里复用它。</li></ul><p>最佳实践：</p><ol><li>让模块只抛出与当前抽象级别一致的异常；</li><li>让模块只抛出与当前抽象级别一致的异常；</li></ol><p>DEMO 调整：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># {PROJECT}/util/image/processor.py</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ImageOpenError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;图像打开错误异常类
</span></span></span><span class=line><span class=cl><span class=s2>    :param exc: 原始异常
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>exc</span> <span class=o>=</span> <span class=n>exc</span>
</span></span><span class=line><span class=cl>        <span class=c1># 调用异常父类方法，初始化错误信息</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Image open error: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>exc</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_image</span><span class=p>(</span><span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>ImageOpenError</span><span class=p>(</span><span class=n>exc</span><span class=o>=</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1># {PROJECT}/app/views.py   </span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>foo_view_function</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>process_image</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>ImageOpenError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>error_codes</span><span class=o>.</span><span class=n>INVALID_IMAGE_UPLOADED</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=包装抽象级别低于当前模块的异常>包装抽象级别低于当前模块的异常</h4><p>避免抛出高于当前抽象级别的异常外，我们同样应该避免泄露低于当前抽象级别的异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;https://www.invalid-host-foo.com&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span><span class=s1>&#39;&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>urllib3模块是requests依赖的低层实现细节，而这个细节在未来是有可能变动的。当某天requests真的要修改低层实现时，这些包装过的异常类，就可以避免对用户侧的错误处理逻辑产生不良影响。</p><h2 id=编程建议>编程建议</h2><h3 id=不要随意忽略异常>不要随意忽略异常</h3><ul><li>在 except 里面捕获并且处理，继续执行后面的代码</li><li>在 except 中捕获，并且发送通知，中断执行</li><li>不捕获异常，让异常继续向上抛</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>send_sms_notification</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>RequestError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div><p>“这个短信通知根本不重要，即使失败了也没关系。”但即便这样，通过日志记录下这个异常总会更好：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>send_sms_notification</span><span class=p>(</span><span class=n>user</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>RequestError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;RequestError while sending SMS notification to </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=不要手动做数据校验>不要手动做数据校验</h3><ul><li>不要手动判断，使用一些造好的轮子。去抽出专门做数据校验的逻辑</li><li>pydantic、django serializer、wtforms 等等</li></ul><h3 id=抛出可区分的异常>抛出可区分的异常</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_from_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>CreateItemError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;item&lt;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&gt; created&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1># 如果调用方想针对“items已满”这类错误增加一些特殊逻辑，比如清空所有items，我们就得把上面的代码改成下面这样</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_from_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>CreateItemError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果已满，清空所有 items</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;items is full&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>clear_all_items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;item&lt;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&gt; created&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>利用异常间的继承关系，设计一些更精准的异常子类</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateItemError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建 Item 失败&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateErrorItemsFull</span><span class=p>(</span><span class=n>CreateItemError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;当前的Item 容器已满&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>MAX_LENGTH_OF_NAME</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateItemError</span><span class=p>(</span><span class=s1>&#39;name of item is too long&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>get_current_items</span><span class=p>())</span> <span class=o>&gt;</span> <span class=n>MAX_ITEMS_QUOTA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateErrorItemsFull</span><span class=p>(</span><span class=s1>&#39;items is full&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Item</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_from_input</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span> <span class=o>=</span> <span class=n>create_item</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>CreateErrorItemsFull</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>clear_all_items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>CreateItemError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;create item failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;item&lt;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>&gt; created&#39;</span><span class=p>)</span>  
</span></span></code></pre></td></tr></table></div></div><ul><li><p>除了设计更精确的异常子类外，你还可以创建一些包含额外属性的异常类，比如包含“错误代码”（error_code）的CreateItemError类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateItemError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建 Item 失败
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param error_code: 错误代码
</span></span></span><span class=line><span class=cl><span class=s2>    :param message: 错误信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>error_code</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>error_code</span> <span class=o>=</span> <span class=n>error_code</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message</span> <span class=o>=</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>error_code</span><span class=si>}</span><span class=s1> - </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 抛出异常时指定 error_code</span>
</span></span><span class=line><span class=cl><span class=k>raise</span> <span class=n>CreateItemError</span><span class=p>(</span><span class=s1>&#39;name_too_long&#39;</span><span class=p>,</span> <span class=s1>&#39;name of item is too long&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>raise</span> <span class=n>CreateItemError</span><span class=p>(</span><span class=s1>&#39;items_full&#39;</span><span class=p>,</span> <span class=s1>&#39;items is full&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=不要使用-assert-来检查参数合法性>不要使用 assert 来检查参数合法性</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_string</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=nb>str</span><span class=p>),</span> <span class=s1>&#39;s must be string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>assert是一个专供开发者调试程序的关键字。它所提供的断言检查，可以在执行Python时使用-O选项直接跳过。</p><p>不要使用 assert 来做参数校验，使用 raise 语句。</p><h3 id=无需处理是最好的错误处理>无需处理是最好的错误处理</h3><h4 id=一个小故事>一个小故事</h4><p>Tcl 语言设计的 unset 命令，用来删除某个变量。在设计这个命令时，作者认为当人们用unset删除一个不存在的变量时，一定是不正常的，程序自然应该抛出一个错误。</p><p>当人们调用unset时，其实常常处在一种模棱两可的程序状态中——不确定变量是否存在。这时，unset的设计就会让它用起来非常尴尬。大部分人在使用unset时，几乎都需要编写额外的代码来捕获unset可能抛出的错误。</p><p>如果可以重新设计unset命令，他会对它的职责做一些调整：不再把unset当成一种可能会失败的删除变量行为，而是把它当作一种确保某变量不存在的命令。当unset的职责改变后，即使变量不存在，它也可以不抛出任何错误，直接返回就好。</p><p>一个思路上的调整：<strong>在设计API时，如果稍微调整一下思考问题的角度，修改API的抽象定义，那么那些原本需要处理的错误，也许就会神奇地消失。假如API不抛出错误，调用方也就不需要处理错误，这会大大减轻大家的心智负担。</strong></p><h4 id=空对象模式>空对象模式</h4><p>调查问卷，全部为字符串，正常的得分记录是{username} {points}格式。写一个脚本，统计合格（大于等于80）的得分记录总数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>data = [&#39;piglei 96&#39;, &#39;joe 100&#39;, &#39;invalid-data&#39;, &#39;roland $invalid_points&#39;, ...]
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>QUALIFIED_POINTS</span> <span class=o>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CreateUserPointError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建得分纪录失败时抛出&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserPoint</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用户得分记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>points</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>points</span> <span class=o>=</span> <span class=n>points</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_qualified</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;返回得分是否合格&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>points</span> <span class=o>&gt;=</span> <span class=n>QUALIFIED_POINTS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_userpoint</span><span class=p>(</span><span class=n>point_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从字符串初始化一条得分记录
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param point_string: 形如piglei 1 的表示得分记录的字符串
</span></span></span><span class=line><span class=cl><span class=s2>    :return: UserPoint 对象
</span></span></span><span class=line><span class=cl><span class=s2>    :raises: 当输入数据不合法时返回 CreateUserPointError
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>,</span> <span class=n>points</span> <span class=o>=</span> <span class=n>point_string</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>points</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateUserPointError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;input must follow pattern &#34;</span><span class=si>{username}</span><span class=s1> </span><span class=si>{points}</span><span class=s1>&#34;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>points</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CreateUserPointError</span><span class=p>(</span><span class=s1>&#39;points can not be negative&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>UserPoint</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_qualified</span><span class=p>(</span><span class=n>points_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算得分合格的总人数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param points_data: 字符串格式的用户得分列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>point_string</span> <span class=ow>in</span> <span class=n>points_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>point_obj</span> <span class=o>=</span> <span class=n>make_userpoint</span><span class=p>(</span><span class=n>point_string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>CreateUserPointError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>+=</span> <span class=n>point_obj</span><span class=o>.</span><span class=n>is_qualified</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;piglei 96&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;nobody 61&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;cotton 83&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;invalid_data&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;roland $invalid_points&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;alfred -3&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>count_qualified</span><span class=p>(</span><span class=n>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 输出结果：</span>
</span></span><span class=line><span class=cl><span class=c1># 2</span>
</span></span></code></pre></td></tr></table></div></div><p>每当调用方使用make_userpoint()时，都必须加上try/except语句来捕获异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>QUALIFIED_POINTS</span> <span class=o>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserPoint</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用户得分记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>username</span><span class=p>,</span> <span class=n>points</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=n>username</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>points</span> <span class=o>=</span> <span class=n>points</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_qualified</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;返回得分是否合格&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>points</span> <span class=o>&gt;=</span> <span class=n>QUALIFIED_POINTS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NullUserPoint</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;一个空的用户得分记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>points</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_qualified</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_userpoint</span><span class=p>(</span><span class=n>point_string</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从字符串初始化一条得分记录
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param point_string: 形如piglei 1 的表示得分记录的字符串
</span></span></span><span class=line><span class=cl><span class=s2>    :return: 如果输入合法，返回 UserPoint 对象，否则返回 NullUserPoint
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>,</span> <span class=n>points</span> <span class=o>=</span> <span class=n>point_string</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>points</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NullUserPoint</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>points</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NullUserPoint</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>UserPoint</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>count_qualified</span><span class=p>(</span><span class=n>points_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算得分合格的总人数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param points_data: 字符串格式的用户得分列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>make_userpoint</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=o>.</span><span class=n>is_qualified</span><span class=p>()</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>points_data</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><ul><li>make_userpoint()总是会返回一个符合要求的对象（UserPoint()或NullUserPoint()）</li><li>“空对象模式”也是一种转换设计观念以避免错误处理的技巧。当函数进入边界情况时，“空对象模式”不再抛出错误，而是让其返回一个类似于正常结果的特殊对象，因此使用方自然就不必处理任何错误，人们写起代码来也会更轻松。</li></ul><h2 id=总结>总结</h2><h3 id=基础知识-1>基础知识</h3><ul><li><p>一个try语句支持多个except子句，但请记得把更精确的异常类放在前面</p></li><li><p>try语句的else分支会在没有异常时执行，因此它可用来替代标记变量</p></li><li><p>不带任何参数的raise语句会重复抛出当前异常</p></li><li><p>上下文管理器经常用来处理异常，它最常见的用途是替代finally子句</p></li><li><p>上下文管理器可以用来忽略某段代码里的异常</p></li><li><p>使用@contextmanager装饰器可以轻松定义上下文管理器</p></li></ul><h3 id=错误处理和参数校验>错误处理和参数校验</h3><ul><li>当你可以选择编写条件判断或异常捕获时，优先选异常捕获（EAFP）</li><li>不要让函数返回错误信息，直接抛出自定义异常吧</li><li>手动校验数据合法性非常烦琐，尽量使用专业模块来做这件事</li><li>不要使用assert来做参数校验，用raise替代它</li><li>处理错误需要付出额外成本，假如能通过设计避免它就再好不过了</li><li>在设计API时，需要慎重考虑是否真的有必要抛出错误</li><li>使用“空对象模式”能免去一些针对边界情况的错误处理工作</li></ul><h3 id=当你捕获异常时>当你捕获异常时</h3><ul><li>过于模糊和宽泛的异常捕获可能会让程序免于崩溃，但也可能会带来更大的麻烦</li><li>异常捕获贵在精确，只捕获可能抛出异常的语句，只捕获可能的异常类型</li><li>有时候，让程序提早崩溃未必是什么坏事</li><li>完全忽略异常是风险非常高的行为，大多数情况下，至少记录一条错误日志</li></ul><h3 id=当你抛出异常时>当你抛出异常时</h3><ul><li>保证模块内抛出的异常与模块自身的抽象级别一致</li><li>如果异常的抽象级别过高，把它替换为更低级的新异常</li><li>如果异常的抽象级别过低，把它包装成更高级的异常，然后重新抛出</li><li>不要让调用方用字符串匹配来判断异常种类，尽量提供可区分的异常</li></ul><h2 id=参考>参考</h2><ul><li>Python 工匠</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>Chen Guixian</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2022-11-18</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/python/>Python</a></div><nav class=post-nav><a class=prev href=/post/python/python-eafp-lbyl-code-styles/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Python EAFP LBYL 编程风格</span>
<span class="prev-text nav-mobile">上一篇</span>
</a><a class=next href=/post/tools/mac-tools/><span class="next-text nav-default">Mac 工具记录</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span><span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2017 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span>Chen Guixian</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script></body></html>